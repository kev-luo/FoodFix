<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.9.1/css/bulma.min.css">
    <script defer src="https://use.fontawesome.com/releases/v5.14.0/js/all.js"></script>

</head>
<body>
    <div id="graphContainer" style="width: 50%;"></div>

    <table class="table">
        <thead>
            <tr>
                <th><abbr title="Ingredient">Ingredient</abbr></th>
                <th><abbr title="Amount">Amount</abbr></th>
                <th><abbr title="Unit">Unit</abbr></th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>Chicken</td>
                <td>1</td>
                <td>Whole</td>

            </tr>
            <tr>
                <td>Garlic</td>
                <td>11</td>
                <td>Cloves</td>

            </tr>
        </tbody>
    </table>

    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@0.7.0"></script>
    <script>

    $(document).ready(function() {
        
        // get recipeId from localStorage
        var recipeId = localStorage.getItem("recipeId");
        
        var key = '59df629ffde7493d810c678d689d0889';
        
        getIngredients(recipeId);
        getNutrients(recipeId);

        // function to get recipe ingredients
        function getIngredients(recipeId) {
            // URL for detailed ingredients
            var ingredId = recipeId;
            var ingQueryUrl = `https://api.spoonacular.com/recipes/${ingredId}/information?apiKey=${key}`;

            // ajax call to get ingredients
            $.ajax({
                url: ingQueryUrl,
                method: "GET"
            }).then(function(response) {
                console.log(response);

                // declare variable that holds all ingredients information
                var allIngr = [];
                var ingreds = response.extendedIngredients;
                var servings = response.servings;

                // for loop to loop through all items in response.extendedIngredients
                for (var i=0, j=ingreds.length; i<j; i++) {

                    // for each ingredient concatenate amount+units+ingredient into one string
                    if (ingreds[i].unit !== '') {
                        var concatIngr = `${ingreds[i].amount} ${ingreds[i].unit} ${ingreds[i].name}`;
                    // if there are no units, exclude units from concatenation
                    } else {
                        var concatIngr = `${ingreds[i].amount} ${ingreds[i].name}`;
                    }

                    // add ingredients to ingredients array
                    allIngr.push(concatIngr);
                }
            })
        }
            
        // function to get nutrients
        function getNutrients(recipeId) {
            // URL for recipe nutrition
            var nutrId = recipeId;
            var nutrQueryUrl = `https://api.spoonacular.com/recipes/${nutrId}/nutritionWidget.json?apiKey=${key}`

            // ajax call to get nutrients
            $.ajax({
                url: nutrQueryUrl,
                get: "GET"
            }).then(function(response) {

                // declare objects to store detailed nutrition facts
                var nutrientsBad = {};
                var nutrientsGood = {};

                // console.log(response);

                // store overview facts in object. should this be displayed alongside recipe display?
                // var quickNutrFacts = {
                //     calories: response.calories,
                //     carbs: response.carbs,
                //     fat: response.fat,
                //     protein: response.protein
                // }

                // store nutrition fact objects in objects
                var badNutr = response.bad.length;
                for (var i=0; i<badNutr; i++) {
                    nutrientsBad[response.bad[i].title] = response.bad[i];
                }

                // store nutrition fact objects in objects
                var goodNutr = response.good.length;
                for (var i=0; i<goodNutr; i++) {
                    nutrientsGood[response.good[i].title] = response.good[i];
                }

                // first y axis labels
                var badNutrNames = [];
                // second y axis labels
                var goodNutrNames = [];
                // first dataset x axis
                var badPerc = [];
                // second dataset x axis
                var goodPerc = [];

                $.each(nutrientsBad,function(key) {
                    badNutrNames.push(key + ':  ' + nutrientsBad[key].amount);
                    badPerc.push(nutrientsBad[key].percentOfDailyNeeds);
                })
                $.each(nutrientsGood,function(key) {
                    goodNutrNames.push(key + ':  ' + nutrientsGood[key].amount);
                    goodPerc.push(nutrientsGood[key].percentOfDailyNeeds);
                })

                var chartDataBad = {
                    labels: badNutrNames,
                    datasets: [{
                        label: 'Limit These',
                        backgroundColor: 'rgb(255, 99, 132)',
                        borderColor: 'rgb(255, 99, 132)',
                        borderWidth: 1,
                        data: badPerc
                    }]
                }
                
                var chartDataGood = {
                    labels: goodNutrNames,
                    datasets: [{
                        label: 'Get Enough of These',
                        backgroundColor: 'rgb(61, 100, 251)',
                        borderColor: 'rgb(61, 100, 251)',
                        borderWidth: 1,
                        data: goodPerc
                    }]
                }

                var newCanvBad = $("<canvas>",{
                    id: "myBadChart"
                })

                var newCanvGood = $("<canvas>",{
                    id: "myGoodChart"
                })

                var ctxBad = newCanvBad.get(0).getContext('2d');
                var chartBad = new Chart(ctxBad, {
                    type: 'horizontalBar',
                    data: chartDataBad,
                    options: {
                        plugins: {
                            datalabels: {
                                color: 'rgb(255, 99, 132)',
                                anchor: 'end',
                                offset: 10, 
                                formatter: function(value) {
                                    return value+"%";
                                }
                            }
                        },
                        elements: {
                            rectangle: {
                                borderWidth: 2,
                            }
                        },
                        responsive: true,
                        scales: {
                            xAxes: [{
                                gridLines: {
                                    display: true,
                                    drawBorder: true,
                                    drawOnChartArea: false,
                                },
                                scaleLabel: {
                                    display: true,
                                    labelString: 'Percent of Daily Needs'
                                }
                            }],
                            yAxes: [{
                                gridLines: {
                                    display: true,
                                    drawBorder: true,
                                    drawOnChartArea: false,
                                }
                            }]
                        },
                        legend: {
                            display: false,
                        },
                        title: {
                            display: true,
                            text: 'Limit These Nutrients'
                        }
                    }
                })

                var ctxGood = newCanvGood.get(0).getContext('2d');
                var chartGood = new Chart(newCanvGood, {
                    type: 'horizontalBar',
                    data: chartDataGood,
                    options: {
                        plugins: {
                            datalabels: {
                                color: 'rgb(61, 100, 251)',
                                anchor: 'end',
                                offset: 10, 
                                formatter: function(value) {
                                    return value+"%";
                                }
                            }
                        },
                        elements: {
                            rectangle: {
                                borderWidth: 2,
                            }
                        },
                        responsive: true,
                        scales: {
                            xAxes: [{
                                gridLines: {
                                    display: true,
                                    drawBorder: true,
                                    drawOnChartArea: false,
                                },
                                scaleLabel: {
                                    display: true,
                                    labelString: 'Percent of Daily Needs'
                                }
                            }],
                            yAxes: [{
                                gridLines: {
                                    display: true,
                                    drawBorder: true,
                                    drawOnChartArea: false,
                                }
                            }]
                        },
                        legend: {
                            display: false,
                        },
                        title: {
                            display: true,
                            text: 'Get Enough of These Nutrients'
                        }
                    }
                })

                $("#graphContainer").append(newCanvBad, newCanvGood);
                console.log(badPerc, goodPerc)
                
            })
        }
    });
    </script>
</body>
</html>