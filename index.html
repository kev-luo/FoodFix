<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.9.1/css/bulma.min.css">
    <script defer src="https://use.fontawesome.com/releases/v5.14.0/js/all.js"></script>

    <style>
        .box {
            box-radius: 'radius-small';
        }
    </style>
</head>


<body>
    
    <div class="field">
        <label class="label">Name</label>
        <div class="control">
          <input class="input" id="recipe" type="text" placeholder="Recipe">
        </div>
        <label class="label">Number of Results</label>
        <div class="control">
            <input class="input" id="numResults" type="text" placeholder="Default 10">
        </div>
    </div>

    <div class="field is-grouped">
        <div class="control">
          <button class="button is-link" id="searchBtn">Display Recipes</button>
        </div>
    </div>

    <div class="section" id="results">
        <div class="box">
            <article class="media">
                <div class="media-left">
                    <figure class="image is-128x128">
                        <img src="https://bulma.io/images/placeholders/128x128.png" alt="Image">
                    </figure>
                </div>
                <div class="media-content"> 
                    <div class="content">
                        <p>John Smith</p>
                    </div>
                </div>
            </article>
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>

    <script>

    $(document).ready(function() {

        var key = '59df629ffde7493d810c678d689d0889';

        // event listener for submit button
        $("#searchBtn").on("click", function(event) {

            event.preventDefault();

            // variables to store user input
            var recipeSearch = $("#recipe").val();
            var numResults = $("#numResults").val();
            // URL for recipes
            var queryUrl = `https://api.spoonacular.com/recipes/complexSearch?apiKey=${key}&query=${recipeSearch}&number=${numResults}`;

            // clear user input
            $("#recipe").val('');
            $("#numResults").val('');
            
            // call function to return list of recipes
            getRecipes(queryUrl, numResults);
            
        })

        // function to return list of recipes
        function getRecipes(queryUrl, numResults) {
            // ajax call to get recipes
            $.ajax({
                url: queryUrl,
                method: "GET"
            }).then(function(response) {
                console.log(response);
                
                for (var i=0; i<(parseInt(numResults)); i++) {
                    // create new box and article
                    var newBox = $("<div>",{"class":"box"});
                    newBox.attr("data-recipeId",response.results[i].id);
                    var newArticle = $("<article>",{"class":"media"});

                    // create tags to hold image for each box
                    var imgDiv = $("<div>",{"class":"media-left"});
                    var newFig = $("<figure>",{"class":"image is-128x128"});
                    var newImg = $("<img>",{
                        src:response.results[i].image, 
                        alt:response.results[i].title,
                    });

                    newFig.append(newImg);
                    imgDiv.append(newFig);

                    var newPara = $("<p>",{text:response.results[i].title});

                    newArticle.append(imgDiv, newPara);
                    newBox.append(newArticle);
                    $("#results").append(newBox);

                }
            })
        }

        $("#results").on("click",".box",function(event) {

            // event.preventDefault();

            var recipeId = $(this).attr("data-recipeId");

            window.location = "displayNutrients.html";

            getIngredients(recipeId);
            getNutrients(recipeId)
        })
        
        // function to get recipe ingredients
        function getIngredients(recipeId) {
            // URL for detailed ingredients
            var ingredId = recipeId;
            var ingQueryUrl = `https://api.spoonacular.com/recipes/${ingredId}/information?apiKey=${key}`;

            // ajax call to get ingredients
            $.ajax({
                url: ingQueryUrl,
                method: "GET"
            }).then(function(response) {
                console.log(response);

                // declare variable that holds all ingredients information
                var allIngr = [];
                var ingreds = response.extendedIngredients;
                var servings = response.servings;
                var recipeId = response.id;

                // for loop to loop through all items in response.extendedIngredients
                for (var i=0, j=ingreds.length; i<j; i++) {

                    // for each ingredient concatenate amount+units+ingredient into one string
                    if (ingreds[i].unit !== '') {
                        var concatIngr = `${ingreds[i].amount} ${ingreds[i].unit} ${ingreds[i].name}`;
                    // if there are no units, exclude units from concatenation
                    } else {
                        var concatIngr = `${ingreds[i].amount} ${ingreds[i].name}`;
                    }

                    // add ingredients to ingredients array
                    allIngr.push(concatIngr);
                }
            })
        }
            
        // function to get nutrients
        function getNutrients(recipeId) {
            // URL for recipe nutrition
            var nutrId = recipeId;
            var nutrQueryUrl = `https://api.spoonacular.com/recipes/${nutrId}/nutritionWidget.json?apiKey=${key}`

            // ajax call to get nutrients
            $.ajax({
                url: nutrQueryUrl,
                get: "GET"
            }).then(function(response) {

                // declare arrays to store detailed nutrition facts
                var nutrientsBadArray = [];
                var nutrientsGoodArray = [];

                // console.log(response);

                // store overview facts in object
                var quickNutrFacts = {
                    calories: response.calories,
                    carbs: response.carbs,
                    fat: response.fat,
                    protein: response.protein
                }

                // store nutrition fact objects in arrays
                var badNutr = response.bad.length;
                for (var i=0; i<badNutr; i++) {
                    var facts = response.bad[i]
                    nutrientsBadArray.push(facts);
                }

                var goodNutr = response.good.length;
                for (var i=0; i<goodNutr; i++) {
                    var goodFacts = response.good[i];
                    nutrientsGoodArray.push(goodFacts);
                }

                console.log(nutrientsBadArray, nutrientsGoodArray)
                
            })
        }
    });
    </script>
</body>
</html>